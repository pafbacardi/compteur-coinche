<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compteur de Coinche</title>
	    <!-- Favicon  -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>♦️</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Styles CSS initiaux pour un look moderne et mobile-first */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5; /* Couleur de fond douce */
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            text-align: center;
            margin-top: 200px; /* Espace pour le header fixe augmenté pour le contrat affiché */
        }
        h1 {
            color: #4CAF50; /* Vert pour le titre */
            margin-bottom: 30px;
            font-weight: 700;
        }
        /* Styles pour le header fixe */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100; /* Assure que le header est au-dessus du contenu */
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .fixed-header h1 {
            margin: 0 0 10px 0;
            font-size: 1.5em;
        }
        .score-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px; /* Ajout de marge pour le contrat en dessous */
            flex-wrap: wrap;
            width: 100%;
            max-width: 600px; /* Aligne avec le container principal */
        }
        .team-score {
            background-color: #e8f5e9; /* Fond léger pour les scores */
            border-radius: 8px;
            padding: 10px 15px; /* Réduit le padding pour le header */
            flex: 1;
            min-width: 150px;
            margin: 5px; /* Réduit la marge */
            cursor: pointer; /* Indique que c'est cliquable */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            text-align: center; /* Cette ligne est déjà présente et assure le centrage */
        }
        .team-score:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }
        .team-score h2 {
            /* Pas de couleur directe ici, on l'appliquera via une classe si besoin */
            margin-top: 0;
            font-size: 1em; /* Réduit la taille du nom d'équipe */
        }
        .score-value {
            font-size: 2em; /* Réduit la taille du score */
            font-weight: 700;
            color: #2196F3; /* Bleu vif par défaut pour les scores */
            margin-top: 5px; /* Réduit la marge */
        }

        
        .score-difference {
            font-size: 1em;
            font-weight: bold;
            margin-top: 5px;
        }
        .score-difference.positive {
            color: #4CAF50;
        }
        .score-difference.negative {
            color: #f44336;
        }

        /* Couleurs spécifiques pour les équipes */
        .team1-color-text { /* Nouvelle classe pour le texte du nom */
            color: #E91E63; /* Rouge pour l'équipe 1 */
        }
        .team2-color-text { /* Nouvelle classe pour le texte du nom */
            color: #2196F3; /* Bleu pour l'équipe 2 */
        }
        /* Pour le texte du contrat réussi/chuté */
        .contract-success-text {
            color: #4CAF50; /* Vert */
        }
        .contract-failure-text {
            color: #f44336; /* Rouge */
        }

        /* Style pour les scores élevés (rouge et gras) */
        .score-high {
            color: #E91E63; /* Rouge pour les scores élevés */
            font-weight: 900; /* Plus gras */
        }

        /* Animation de clignotement */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        /* Classe pour appliquer l'animation de clignotement */
        .blink-animation {
            animation: blink 1s infinite alternate; /* 1s, infini, alternance */
        }

        /* Styles pour les champs d'entrée et autres sections */
        .score-input-section {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
        }
        .score-input-section h3 {
            color: #666;
            margin-bottom: 20px;
            font-weight: 400;
        }
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #555;
        }
        .input-group input[type="number"] {
            width: calc(100% - 24px); /* Pour compenser le padding */
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            box-sizing: border-box;
        }
        /* Nouvelle règle pour réduire la largeur du champ contractPoints */
        #contractPoints {
            width: 80px; /* Largeur fixe pour 4 caractères + padding */
            text-align: center;
            /* margin-right: 15px; Supprimé pour aligner le bouton +10 */
            display: inline-block; /* Pour qu'it soit sur la même ligne que les couleurs */
            vertical-align: middle; /* Alignement vertical */
        }
        /* Style pour le bouton +10 */
        #addTenContractPointsButton {
            width: auto; /* Ajuste la largeur au contenu */
            padding: 8px 12px; /* Padding ajusté */
            font-size: 1em; /* Taille de police légèrement plus petite */
            margin-left: 10px; /* Espace entre le champ et le bouton */
            background-color: #2196F3; /* Bleu */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            vertical-align: middle; /* Alignement vertical */
        }
        #addTenContractPointsButton:hover {
            background-color: #1976D2;
        }
        .radio-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1.1em;
        }
        .radio-group input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2); /* Grossir les radios boutons */
        }
        .checkbox-group {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1.1em;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        button {
            background-color: #4CAF50; /* Bouton vert pour l'action principale */
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-top: 25px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #newGameButton {
            background-color: #FFC107; /* Jaune pour le nouveau jeu */
            margin-top: 15px;
            display: block; /* Force le bouton à être toujours visible */
        }
        #newGameButton:hover {
            background-color: #ffb300;
        }

        /* Style pour le bouton plein écran */
        #fullscreenButton {
            background-color: #607D8B; /* Gris bleu pour le plein écran */
            color: white;
            padding: 15px 30px; /* Adapte le padding pour qu'il ressemble aux autres boutons du bas */
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 700;
            margin-top: 15px; /* Espace après le bouton Nouvelle Partie */
            width: 100%; /* Prend toute la largeur comme les autres boutons du bas */
        }
        #fullscreenButton:hover {
            background-color: #455A64;
        }


        .winner-message {
            font-size: 1.8em;
            font-weight: 700;
            color: #E91E63; /* Rouge vif pour le gagnant */
            margin-top: 20px;
            animation: pulse 1s infinite alternate; /* Petite animation */
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }
        .warning-message {
            color: #FF5722 !important; /* Orange-rouge pour les messages d'avertissement */
            background-color: #ffe0b2; /* Fond plus clair pour le contraste */
            border: 1px solid #FF5722;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
            font-size: 0.9em; /* Légèrement plus petit pour ne pas prendre trop de place */
            text-align: center;
            display: none; /* Toujours caché par défaut, sera activé par JS */
        }

        /* Animation pour les messages d'avertissement */
        .warning-message.show {
            display: block !important;
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }


        /* Styles pour le toggle switch Capot réussi / Capot chuté */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 180px; /* Largeur augmentée pour les textes */
            height: 34px;
            margin: 10px 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4CAF50; /* Vert par défaut (réussi) */
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        /* Couleur du slider quand il est sur "Chuté" */
        input:not(:checked) + .toggle-slider {
            background-color: #f44336; /* Rouge */
        }


        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        /* Quand le toggle est sur "réussi" */
        input:checked + .toggle-slider:before {
            -webkit-transform: translateX(146px); /* Largeur du slider - largeur du cercle - padding gauche */
            -ms-transform: translateX(146px);
            transform: translateX(146px);
        }

        .toggle-labels {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
            padding: 0 10px;
            pointer-events: none; /* Pour que les clics passent au slider */
        }

        .toggle-labels .success-label {
            color: white; /* Blanc quand réussi */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            margin-left: 20px; /* Pour centrer le texte sur le rond */
        }

        .toggle-labels .failure-label {
            color: #ddd; /* Gris clair quand inactif */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            margin-right: 20px;
        }

        /* Ajustement des couleurs de texte des labels en fonction de l'état du toggle */
        input:checked + .toggle-slider + .toggle-labels .success-label {
            color: white;
        }
        input:checked + .toggle-slider + .toggle-labels .failure-label {
            color: #ddd;
        }

        input:not(:checked) + .toggle-slider + .toggle-labels .success-label {
            color: #ddd;
        }
        input:not(:checked) + .toggle-slider + .toggle-labels .failure-label {
            color: white;
        }

        /* Styles pour la ligne de rupture visuelle */
        .section-divider {
            border-top: 3px solid #E91E63; /* Ligne rouge plus épaisse et solide */
            margin: 30px 0; /* Espacement autour de la ligne */
        }

        /* Styles des modales (générique) */
        .modal {
            display: none; /* Caché par défaut */
            position: fixed; /* Reste en place même en scrollant */
            z-index: 1000; /* Par-dessus tout le reste */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Permet le défilement si le contenu est trop grand */
            background-color: rgba(0,0,0,0.6); /* Fond semi-transparent noir */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }
        /* Style spécifique pour la modale de confirmation d'ajout de points */
        #addPointsConfirmationModal .modal-content {
            max-width: 550px; /* Plus large pour l'explication */
            text-align: left; /* Texte aligné à gauche */
        }

        .modal-content h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .modal-content input[type="number"],
        .modal-content input[type="text"] { /* Ajout de input[type="text"] pour la modale de nom */
            width: calc(100% - 24px); /* Pour compenser le padding */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.2em;
            text-align: center;
        }
        /* Pour la modale d'ajout de points, les inputs ne sont pas pertinents */
        #addPointsConfirmationModal input[type="number"],
        #addPointsConfirmationModal input[type="text"] {
            display: none;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-around;
            gap: 15px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px 20px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: auto; /* Annule le 100% du bouton général */
            margin-top: 0; /* Annule le margin-top du bouton général */
        }

        .modal-buttons .save-button, .modal-buttons .confirm-button {
            background-color: #2196F3; /* Bleu pour sauvegarder / confirmer */
            color: white;
            border: none;
        }
        .modal-buttons .save-button:hover, .modal-buttons .confirm-button:hover {
            background-color: #1976D2;
        }

        .modal-buttons .cancel-button {
            background-color: #f44336; /* Rouge pour annuler */
            color: white;
            border: none;
        }
        .modal-buttons .cancel-button:hover {
            background-color: #d32f2f;
        }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2em;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .modal-close-button:hover,
        .modal-close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        /* Styles pour les pictogrammes de couleurs de carte */
        .suit-selection {
            display: flex; /* Utilise flexbox pour l'alignement horizontal */
            justify-content: center; /* Centre les icônes horizontalement */
            gap: 10px; /* Espace entre les icônes */
            margin-top: 15px; /* Espacement au-dessus */
        }
        .suit-icon {
            font-size: 1.8em; /* Taille des icônes */
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            opacity: 0.5; /* Légèrement transparent par default */
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .suit-icon.selected {
            opacity: 1; /* Pleine opacité quand sélectionné */
            transform: scale(1.1); /* Légèrement plus grand quand sélectionné */
            background-color: rgba(0,0,0,0.1); /* Un léger fond pour le rendre plus visible */
        }
        /* Couleurs des icônes */
        .suit-icon[data-suit="hearts"], .suit-icon[data-suit="diamonds"] {
            color: red;
        }
        .suit-icon[data-suit="spades"], .suit-icon[data-suit="clubs"] {
            color: black;
        }

        /* Affichage du contrat dans le header */
        .current-contract-display {
            width: 100%;
            max-width: 600px;
            background-color: #e0f7fa; /* Couleur de fond légère */
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #00796B; /* Couleur du texte */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .current-contract-display .contract-value {
            color: #D32F2F; /* Rouge pour le nombre de points */
        }
        .current-contract-display .contract-suit-icon {
            font-size: 1.4em; /* Taille de l'icône dans l'affichage */
        }
        .current-contract-display .taking-team-name {
            font-weight: bold;
            font-size: 0.9em;
        }

        /* NEW CSS for horizontal layout */
        .contract-details-row {
            display: flex;
            justify-content: space-between; /* Space out the two sections */
            gap: 20px; /* Space between them */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            margin-bottom: 20px; /* Add some margin below the row */
            align-items: flex-start; /* Align items to the top if their content heights differ */
        }

        .contract-points-group,
        .contract-suit-group {
            flex: 1; /* Allow them to grow and shrink */
            min-width: 150px; /* Minimum width before wrapping */
        }

        /* Adjustments for the suit-selection itself within its new context */
        .suit-selection {
            display: flex;
            justify-content: center; /* Center the icons within their container */
            gap: 10px;
            margin-top: 8px; /* Adjust margin as needed, less than 15px if labels are close */
        }

        /* Ensure the contract input and button also align nicely */
        #contractInputAndButton {
            display: flex; /* Make input and button flex items */
            align-items: center; /* Vertically align them */
            gap: 10px; /* Space between input and button */
            margin-top: 8px; /* Align with suit-selection margin-top */
        }

        /* Styles pour la nouvelle zone d'affichage des modificateurs de contrat */
        #contractModifiersDisplay {
            width: 100%;
            max-width: 600px;
            background-color: #e0f7fa; /* Même couleur de fond que le contrat principal */
            border-radius: 8px;
            padding: 5px 15px; /* Moins de padding */
            margin-bottom: 10px; /* Espacement avec le contenu suivant */
            text-align: center;
            font-size: 1em; /* Plus petit que le contrat principal */
            font-weight: bold;
            color: #00796B;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; /* Utiliser flex pour centrer le texte */
            align-items: center;
            justify-content: center;
            min-height: 20px; /* Hauteur minimale pour éviter le saut de mise en page */
        }


        /* Styles pour les petits écrans */
        @media (max-width: 600px) {
            body {
                padding: 0; /* Enlève le padding du body sur mobile pour que le header prenne toute la largeur */
            }
            .fixed-header {
                padding: 10px;
            }
            .container {
                padding: 20px;
                margin-top: 240px; /* Augmenté pour éviter le chevauchement sur mobile */
            }
            h1 {
                font-size: 1.8em;
            }
            .team-input { /* Ce bloc est supprimé, mais si jamais il revient, il faut le prévoir */
                display: none; /* Cache les inputs de nom d'équipe directs */
            }
            .team-score {
                margin: 5px;
            }
            .score-value {
                font-size: 2.5em;
            }
            button {
                padding: 12px 20px;
                font-size: 1.1em;
            }
            #fullscreenButton {
                font-size: 1.1em; /* Ajuste la taille du texte */
                padding: 12px 20px; /* Ajuste le padding */
            }
            .radio-group, .checkbox-group {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            .toggle-switch {
                width: 100%; /* S'adapte à la largeur du conteneur */
            }
            input:checked + .toggle-slider:before {
                -webkit-transform: translateX(calc(100% - 34px)); /* Ajustement dynamique */
                -ms-transform: translateX(calc(100% - 34px));
                transform: translateX(calc(100% - 34px));
            }
            .toggle-labels {
                padding: 0 5px;
            }
            .toggle-labels .success-label {
                margin-left: 10px;
            }
            .modal-content {
                padding: 20px;
            }
            .modal-content h3 {
                font-size: 1.3em;
            }
            .modal-buttons {
                flex-direction: column;
            }
            #contractPoints {
                width: 70px; /* Ajuste la largeur sur mobile */
                /* margin-right: 10px; Supprimé pour aligner le bouton +10 */
            }
            #addTenContractPointsButton {
                font-size: 0.9em;
                padding: 6px 10px;
            }
            .suit-selection {
                flex-wrap: wrap; /* Permet aux icônes de passer à la ligne sur mobile */
                justify-content: center;
                margin-top: 10px;
            }
            .suit-icon {
                font-size: 1.5em;
            }
            #addPointsConfirmationModal .modal-content {
                text-align: center; /* Sur mobile, recentrer le texte */
            }
            #addPointsConfirmationModal ul {
                text-align: left; /* Mais garder la liste alignée à gauche */
            }

            /* On smaller screens, make them stack vertically again */
            .contract-details-row {
                flex-direction: column; /* Stack vertically */
                gap: 0; /* Remove gap when stacked */
            }
            .contract-points-group,
            .contract-suit-group {
                width: 100%; /* Take full width when stacked */
                min-width: unset; /* Remove min-width constraint */
                margin-bottom: 20px; /* Add margin between stacked input groups */
            }
            .contract-suit-group {
                margin-top: 0; /* Remove extra margin if already handled by wrapping */
            }
        }
    </style>
</head>
<body>
    <div class="fixed-header">
        <h1>Compteur de Coinche</h1>
        <div class="score-display">
            <div class="team-score" data-team-id="team1">
                <h2 id="displayTeam1Name" class="team1-color-text">Équipe A</h2>
                <div class="score-value" id="score1">0</div>
                <div class="score-difference" id="scoreDiff1"></div>
            </div>
            <div class="team-score" data-team-id="team2">
                <h2 id="displayTeam2Name" class="team2-color-text">Équipe B</h2>
                <div class="score-value" id="score2">0</div>
                <div class="score-difference" id="scoreDiff2"></div>
            </div>
        </div>
        <div id="currentContractDisplay" class="current-contract-display" style="display:none;">
            Contrat actuel : <span id="displayedContractPoints" class="contract-value"></span> <span id="displayedContractSuit" class="contract-suit-icon"></span> par <span id="displayedTakingTeamName" class="taking-team-name"></span>
        </div>
        <!-- Nouvelle zone d'affichage pour capot, coinche, surcoinche -->
        <div id="contractModifiersDisplay" style="display:none;"></div>
        <div id="winnerMessage" class="winner-message" style="display:none;"></div>
    </div>

    <div class="container">
        <div class="score-input-section">
            <h3>Entrée des points de la manche</h3>

            <div class="contract-details-row">
                <div class="input-group contract-points-group">
                    <label for="contractPoints">Points du contrat :</label>
                    <div id="contractInputAndButton">
                        <input type="number" id="contractPoints" value="" min="80" step="10">
                        <button id="addTenContractPointsButton">+10</button>
                    </div>
                </div>
                
                <div class="input-group contract-suit-group">
                    <label>Couleur du contrat :</label>
                    <div class="suit-selection">
                        <span class="suit-icon" data-suit="spades">&#9824;</span> 
                        <span class="suit-icon" data-suit="hearts">&#9829;</span> 
                        <span class="suit-icon" data-suit="clubs">&#9827;</span>  
                        <span class="suit-icon" data-suit="diamonds">&#9830;</span> 
                    </div>
                </div>
            </div> <div id="contractWarning" class="warning-message"></div>


            <div class="input-group">
                <label>Équipe preneuse du contrat :</label>
                <div class="radio-group">
                    <label><input type="radio" name="takingTeam" value="team1"> <span id="radioTeam1Name" class="team1-color-text">Équipe A</span></label>
                    <label><input type="radio" name="takingTeam" value="team2"> <span id="radioTeam2Name" class="team2-color-text">Équipe B</span></label>
                </div>
            </div>

            <div class="checkbox-group">
                <label><input type="checkbox" id="capot"> Capot annoncé</label>
                <label><input type="checkbox" id="coinche"> Coinche</label>
                <label><input type="checkbox" id="surcoinche" disabled> Surcoinche</label>
            </div>

            <div class="section-divider"></div>

            <div class="input-group">
                <label><span id="labelAnnouncementsTeam1">Annonces <span class="team1-color-text">Équipe A</span></span> :</label>
                <input type="number" id="announcementsTeam1" value="0" min="0" step="10">
            </div>
            <div class="input-group">
                <label><span id="labelAnnouncementsTeam2">Annonces <span class="team2-color-text">Équipe B</span></span> :</label>
                <input type="number" id="announcementsTeam2" value="0" min="0" step="10">
            </div>
            <div class="input-group" id="capotResultToggleGroup" style="display:none;">
                <label>Résultat du Capot annoncé :</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="capotRealizedToggle" checked>
                    <span class="toggle-slider round"></span>
                    <span class="toggle-labels">
                        <span class="failure-label">Chuté</span>
                        <span class="success-label">Réussi</span>
                    </span>
                </label>
            </div>

            <div class="input-group" id="realizedPointsTeam1Group">
                <label><span id="labelRealizedTeam1">Points réalisés par <span class="team1-color-text">Équipe A</span> (plis seulement) :</span></label>
                <input type="number" id="realizedPointsTeam1" value="82" min="0" max="162">
            </div>
            <div class="input-group" id="realizedPointsTeam2Group">
                <label><span id="labelRealizedTeam2">Points réalisés par <span class="team2-color-text">Équipe B</span> (plis seulement) :</span></label>
                <input type="number" id="realizedPointsTeam2" value="80" min="0" max="162">
            </div>
            <div class="checkbox-group">
                <label><input type="checkbox" id="unannouncedCapot"> Capot réalisé (non annoncé)</label>
            </div>
            <div id="realizedPointsWarning" class="warning-message"></div>


            <button id="addPointsButton">Ajouter les points</button>
        </div>

        <button id="newGameButton">Nouvelle Partie</button>
        <button id="fullscreenButton">Plein écran</button>
    </div>

    <div id="scoreCorrectionModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button score-modal-close">&times;</span>
            <h3 id="modalScoreTitle">Modifier le score de l'équipe</h3>
            <input type="number" id="modalScoreInput" value="0" min="0">
            <div class="warning-message" id="modalScoreWarning"></div>
            <div class="modal-buttons">
                <button class="save-button" id="saveScoreButton">Valider</button>
                <button class="cancel-button" id="cancelScoreButton">Annuler</button>
            </div>
        </div>
    </div>

    <div id="nameCorrectionModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button name-modal-close">&times;</span>
            <h3 id="modalNameTitle">Modifier le nom de l'équipe</h3>
            <input type="text" id="modalNameInput" value="">
            <div class="warning-message" id="modalNameWarning"></div>
            <div class="modal-buttons">
                <button class="save-button" id="saveNameButton">Valider</button>
                <button class="cancel-button" id="cancelNameButton">Annuler</button>
            </div>
        </div>
    </div>

    <div id="newGameConfirmationModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button new-game-modal-close">&times;</span>
            <h3>Confirmer la nouvelle partie</h3>
            <p>Es-tu sûr(e) de vouloir démarrer une nouvelle partie ? Le score actuel sera réinitialisé.</p>
            <div class="modal-buttons">
                <button class="confirm-button" id="confirmNewGameButton">Oui</button>
                <button class="cancel-button" id="cancelNewGameButton">Non</button>
            </div>
        </div>
    </div>

    <div id="addPointsConfirmationModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button add-points-modal-close">&times;</span>
            <h3 id="addPointsModalTitle"></h3> <p id="contractResultStatus" style="font-weight: bold; font-size: 1.2em; margin-bottom: 15px;"></p>
            <p><span id="confirmTeam1Name" class="team1-color-text"></span> : +<span id="confirmScoreTeam1"></span> points</p>
            <p><span id="confirmTeam2Name" class="team2-color-text"></span> : +<span id="confirmScoreTeam2"></span> points</p>
            <h4>Détail du calcul :</h4>
            <ul id="calculationDetailsList"></ul>
            <div id="addPointsConfirmationWarning" class="modal-warning-message"></div>
            <div class="modal-buttons">
                <button class="confirm-button" id="confirmAddPointsButton">Accepter et Ajouter</button>
                <button class="cancel-button" id="cancelAddPointsButton">Annuler</button>
            </div>
        </div>
    </div>


    <script>
        // --- Variables globales et chargement initial ---
        const TEAM1_ID = 'team1';
        const TEAM2_ID = 'team2';
        const TARGET_SCORE = 3000; // Score cible pour gagner la partie
        const HIGH_SCORE_THRESHOLD = 2500; // Seuil pour afficher le score en rouge et gras
        const TOTAL_PLIS_POINTS = 162; // Total des points des plis dans une manche
        const CAPOT_BASE_POINTS_COINCHE = 250; // Points de base pour un capot coinché/surcoinché (annoncé)
        const CAPOT_BASE_POINTS_NORMAL = 500; // Points de base pour un capot normal (non coinché)
        const CAPOT_UNANNOUNCED_POINTS = 250; // Points pour un capot réalisé mais non annoncé
        const MIN_CONTRACT_POINTS = 80; // Points minimum pour un contrat
        const MAX_CONTRACT_POINTS = 9990; // Supprimer le plafond de 160 (ou mettre un très grand nombre)

        let scores = {
            [TEAM1_ID]: 0,
            [TEAM2_ID]: 0
        };

        let teamNames = {
            [TEAM1_ID]: 'Équipe A',
            [TEAM2_ID]: 'Équipe B'
        };

        let currentTeamBeingCorrected = null; // Pour savoir quelle équipe est modifiée dans la modale de score
        let currentTeamNameBeingEdited = null; // Pour savoir quelle équipe est modifiée dans la modale de nom

        let currentContract = {
            points: 0,
            suit: '', // Pique, Coeur, Carreau, Trèfle
            takingTeam: '', // team1 ou team2
            type: '' // 'capot_announced' ou ''
        };

        // Variables pour stocker les points calculés avant confirmation
        let lastCalculatedScores = {
            [TEAM1_ID]: 0,
            [TEAM2_ID]: 0
        };
        let lastCalculationExplanation = [];
        let lastContractOutcome = ''; // 'réussi' ou 'chuté'


        // --- Récupération des éléments du DOM ---
        const displayTeam1Name = document.getElementById('displayTeam1Name');
        const displayTeam2Name = document.getElementById('displayTeam2Name');
        const score1Display = document.getElementById('score1');
        const score2Display = document.getElementById('score2');
        const contractPointsInput = document.getElementById('contractPoints');
        const addTenContractPointsButton = document.getElementById('addTenContractPointsButton'); // Nouveau bouton
        const realizedPointsTeam1Input = document.getElementById('realizedPointsTeam1');
        const realizedPointsTeam2Input = document.getElementById('realizedPointsTeam2');
        const takingTeamRadios = document.querySelectorAll('input[name="takingTeam"]');
        const coincheCheckbox = document.getElementById('coinche');
        const surcoincheCheckbox = document.getElementById('surcoinche');
        const capotCheckbox = document.getElementById('capot'); // Capot annoncé
        const unannouncedCapotCheckbox = document.getElementById('unannouncedCapot'); // Capot réalisé non annoncé
        
        // Nouveaux éléments pour le toggle Capot réussi / Capot chuté
        const capotResultToggleGroup = document.getElementById('capotResultToggleGroup');
        const capotRealizedToggle = document.getElementById('capotRealizedToggle');

        // Nouveaux éléments pour les groupes de champs à masquer/afficher
        const contractInputAndButton = document.getElementById('contractInputAndButton'); // Nouveau
        const realizedPointsTeam1Group = document.getElementById('realizedPointsTeam1Group');
        const realizedPointsTeam2Group = document.getElementById('realizedPointsTeam2Group');

        // Éléments des annonces (mis à jour suite au déplacement)
        const announcementsTeam1Input = document.getElementById('announcementsTeam1');
        const announcementsTeam2Input = document.getElementById('announcementsTeam2');

        const addPointsButton = document.getElementById('addPointsButton');
        const newGameButton = document.getElementById('newGameButton');
        const winnerMessage = document.getElementById('winnerMessage');
        const contractWarning = document.getElementById('contractWarning');
        const realizedPointsWarning = document.getElementById('realizedPointsWarning');

        // Nouveaux éléments pour les noms dynamiques et les couleurs
        const radioTeam1Name = document.getElementById('radioTeam1Name');
        const radioTeam2Name = document.getElementById('radioTeam2Name');
        const labelAnnouncementsTeam1 = document.getElementById('labelAnnouncementsTeam1');
        const labelAnnouncementsTeam2 = document.getElementById('labelAnnouncementsTeam2');
        const labelRealizedTeam1 = document.getElementById('labelRealizedTeam1');
        const labelRealizedTeam2 = document.getElementById('labelRealizedTeam2');

        // Éléments des pictogrammes de couleur
        const suitIcons = document.querySelectorAll('.suit-icon');

        // Éléments d'affichage du contrat dans le header
        const currentContractDisplay = document.getElementById('currentContractDisplay');
        const displayedContractPoints = document.getElementById('displayedContractPoints');
        const displayedContractSuit = document.getElementById('displayedContractSuit');
        const displayedTakingTeamName = document.getElementById('displayedTakingTeamName');
        // Nouvelle zone d'affichage pour les modificateurs
        const contractModifiersDisplay = document.getElementById('contractModifiersDisplay');


        // Éléments de la modale de correction de score
        const scoreCorrectionModal = document.getElementById('scoreCorrectionModal');
        const modalScoreTitle = document.getElementById('modalScoreTitle');
        const modalScoreInput = document.getElementById('modalScoreInput');
        const modalScoreWarning = document.getElementById('modalScoreWarning');
        const saveScoreButton = document.getElementById('saveScoreButton');
        const cancelScoreButton = document.getElementById('cancelScoreButton');
        const scoreModalCloseButton = document.querySelector('.score-modal-close');

        // Éléments de la modale de modification de nom
        const nameCorrectionModal = document.getElementById('nameCorrectionModal');
        const modalNameTitle = document.getElementById('modalNameTitle');
        const modalNameInput = document.getElementById('modalNameInput');
        const modalNameWarning = document.getElementById('modalNameWarning');
        const saveNameButton = document.getElementById('saveNameButton');
        const cancelNameButton = document.getElementById('cancelNameButton');
        const nameModalCloseButton = document.querySelector('.name-modal-close');

        // Éléments de la modale de confirmation Nouvelle Partie
        const newGameConfirmationModal = document.getElementById('newGameConfirmationModal');
        const confirmNewGameButton = document.getElementById('confirmNewGameButton');
        const cancelNewGameButton = document.getElementById('cancelNewGameButton');
        const newGameModalCloseButton = document.querySelector('.new-game-modal-close');

        // Nouveaux éléments de la modale de confirmation d'ajout de points
        const addPointsConfirmationModal = document.getElementById('addPointsConfirmationModal');
        const addPointsModalTitle = document.getElementById('addPointsModalTitle'); // Nouveau
        const contractResultStatus = document.getElementById('contractResultStatus'); // Nouveau
        const confirmTeam1Name = document.getElementById('confirmTeam1Name');
        const confirmScoreTeam1 = document.getElementById('confirmScoreTeam1');
        const confirmTeam2Name = document.getElementById('confirmTeam2Name');
        const confirmScoreTeam2 = document.getElementById('confirmScoreTeam2');
        const calculationDetailsList = document.getElementById('calculationDetailsList');
        const addPointsConfirmationWarning = document.getElementById('addPointsConfirmationWarning');
        const confirmAddPointsButton = document.getElementById('confirmAddPointsButton');
        const cancelAddPointsButton = document.getElementById('cancelAddPointsButton');
        const addPointsModalCloseButton = document.querySelector('.add-points-modal-close');


        // Bouton plein écran
        const fullscreenButton = document.getElementById('fullscreenButton');


        // --- Fonctions utilitaires ---

        // Fonction pour afficher un message d'avertissement et ajouter la classe 'show'
        function showWarning(element, message) {
            element.textContent = message;
            element.classList.add('show');
        }

        // Fonction pour masquer un message d'avertissement et retirer la classe 'show'
        function hideWarning(element) {
            element.textContent = '';
            element.classList.remove('show');
        }

        // Fonction pour arrondir à la dizaine la plus proche
        function roundToNearestTen(num) {
            return Math.round(num / 10) * 10;
        }

        // Sauvegarde les données dans le Local Storage du navigateur
        function saveGame() {
            localStorage.setItem('coincheScores', JSON.stringify(scores));
            localStorage.setItem('coincheTeamNames', JSON.stringify(teamNames));
            // Ne pas sauvegarder currentContract ici, car il est éphémère pour l'affichage live
        }

        // Charge les données depuis le Local Storage
        function loadGame() {
            const savedScores = localStorage.getItem('coincheScores');
            const savedNames = localStorage.getItem('coincheTeamNames');

            if (savedScores) {
                scores = JSON.parse(savedScores);
            }
            if (savedNames) {
                teamNames = JSON.parse(savedNames);
            }
            updateDisplay();
            updateContractDisplay(); // Met à jour l'affichage du contrat (qui sera vide si aucune saisie n'erit en cours)
            updateContractModifiersDisplay(); // Met à jour l'affichage des modificateurs au chargement
            checkGameEnd(); // Vérifie si la partie est déjà terminée au chargement pour gérer l'état du bouton "Ajouter points"
        }

        // Met à jour l'affichage des noms et scores
        function updateDisplay() {
            displayTeam1Name.textContent = teamNames[TEAM1_ID];
            displayTeam2Name.textContent = teamNames[TEAM2_ID];

            // Applique la couleur au nom de l'équipe
            displayTeam1Name.classList.add('team1-color-text');
            displayTeam2Name.classList.add('team2-color-text');

            // Met à jour le score et applique/retire la classe 'score-high' et 'blink-animation'
            // Affichage de l'écart de score
            const scoreDiff = scores[TEAM1_ID] - scores[TEAM2_ID];

            const scoreDiff1 = document.getElementById('scoreDiff1');
            scoreDiff1.textContent = scoreDiff > 0 ? `+${scoreDiff}` : scoreDiff < 0 ? `${scoreDiff}` : '0';
            scoreDiff1.className = 'score-difference ' + (scoreDiff > 0 ? 'positive' : scoreDiff < 0 ? 'negative' : '');

            const scoreDiff2 = document.getElementById('scoreDiff2');
            scoreDiff2.textContent = scoreDiff < 0 ? `+${-scoreDiff}` : scoreDiff > 0 ? `-${scoreDiff}` : '0';
            scoreDiff2.className = 'score-difference ' + (scoreDiff < 0 ? 'positive' : scoreDiff > 0 ? 'negative' : '');

            score1Display.textContent = scores[TEAM1_ID];
            if (scores[TEAM1_ID] >= HIGH_SCORE_THRESHOLD) {
                score1Display.classList.add('score-high');
                score1Display.classList.add('blink-animation');
            } else {
                score1Display.classList.remove('score-high');
                score1Display.classList.remove('blink-animation');
            }

            score2Display.textContent = scores[TEAM2_ID];
            if (scores[TEAM2_ID] >= HIGH_SCORE_THRESHOLD) {
                score2Display.classList.add('score-high');
                score2Display.classList.add('blink-animation');
            } else {
                score2Display.classList.remove('score-high');
                score2Display.classList.remove('blink-animation');
            }


            // Met à jour les noms dans la section de saisie des points avec les couleurs
            radioTeam1Name.textContent = teamNames[TEAM1_ID];
            radioTeam2Name.textContent = teamNames[TEAM2_ID];
            
            // Met à jour les labels avec les spans colorées
            labelAnnouncementsTeam1.innerHTML = `Annonces <span class="team1-color-text">${teamNames[TEAM1_ID]}</span>`;
            labelAnnouncementsTeam2.innerHTML = `Annonces <span class="team2-color-text">${teamNames[TEAM2_ID]}</span>`;
            labelRealizedTeam1.innerHTML = `Points réalisés par <span class="team1-color-text">${teamNames[TEAM1_ID]}</span> (plis seulement) :`;
            labelRealizedTeam2.innerHTML = `Points réalisés par <span class="team2-color-text">${teamNames[TEAM2_ID]}</span> (plis seulement) :`;
        }

        // Met à jour l'affichage du contrat dans le header
        function updateContractDisplay() {
            // Check if it's an announced capot
            if (currentContract.type === 'capot_announced' && currentContract.suit) { // Also check for suit presence
                const capotSuitSymbol = getSuitSymbol(currentContract.suit);
                const capotSuitColor = getSuitColor(currentContract.suit);
                displayedContractPoints.textContent = 'Capot';
                displayedContractSuit.innerHTML = `à <span style="color: ${capotSuitColor};">${capotSuitSymbol}</span>`; // New format
                displayedTakingTeamName.textContent = teamNames[currentContract.takingTeam];
                displayedTakingTeamName.className = `taking-team-name ${currentContract.takingTeam}-color-text`;
                currentContractDisplay.style.display = 'flex';
            }
            // Existing logic for normal contract display
            else if (currentContract.suit || currentContract.points > 0) { // Condition ajustée
                displayedContractPoints.textContent = currentContract.points;
                displayedContractSuit.innerHTML = getSuitSymbol(currentContract.suit);
                displayedContractSuit.style.color = getSuitColor(currentContract.suit);
                displayedTakingTeamName.textContent = teamNames[currentContract.takingTeam];
                displayedTakingTeamName.className = `taking-team-name ${currentContract.takingTeam}-color-text`; 
                currentContractDisplay.style.display = 'flex'; // Afficher le bloc
            } else {
                currentContractDisplay.style.display = 'none'; // Cacher si pas de contrat en cours de saisie
            }
            updateContractModifiersDisplay(); // Toujours mettre à jour les modificateurs
        }

        // Fonction pour mettre à jour la nouvelle zone d'affichage des modificateurs
        function updateContractModifiersDisplay() {
            let modifiersText = [];
            if (capotCheckbox.checked) {
                modifiersText.push("Capot");
            }
            if (coincheCheckbox.checked) {
                modifiersText.push("Coinché");
            }
            if (surcoincheCheckbox.checked) {
                modifiersText.push("Surcoinché");
            }

            if (modifiersText.length > 0) {
                contractModifiersDisplay.textContent = modifiersText.join(" ");
                contractModifiersDisplay.style.display = 'flex';
            } else {
                contractModifiersDisplay.textContent = '';
                contractModifiersDisplay.style.display = 'none';
            }
        }


        // Fonction pour obtenir le symbole de la couleur
        function getSuitSymbol(suit) {
            switch (suit) {
                case 'spades': return '&#9824;'; // Pique
                case 'hearts': return '&#9829;'; // Cœur
                case 'clubs': return '&#9827;';  // Trèfle
                case 'diamonds': return '&#9830;'; // Carreau
                default: return ''; // Ne devrait pas arriver si une couleur est sélectionnée
            }
        }

        // Fonction pour obtenir la couleur du symbole
        function getSuitColor(suit) {
            switch (suit) {
                case 'hearts':
                case 'diamonds': return 'red';
                case 'spades':
                case 'clubs': return 'black';
                default: return '#00796B'; // Couleur par défaut si non trouvé
            }
        }

        // Réinitialise les champs de saisie pour une nouvelle manche
        function resetInputFields() {
            contractPointsInput.value = ''; 
            realizedPointsTeam1Input.value = TOTAL_PLIS_POINTS / 2; // Ex: 81
            realizedPointsTeam2Input.value = TOTAL_PLIS_POINTS / 2; // Ex: 81
            coincheCheckbox.checked = false;
            surcoincheCheckbox.checked = false;
            surcoincheCheckbox.disabled = true; // Disable surcoinche by default
            capotCheckbox.checked = false; // Capot annoncé
	    capotCheckbox.disabled = false;
            unannouncedCapotCheckbox.checked = false; // Capot réalisé non annoncé
            unannouncedCapotCheckbox.disabled = false; // Réactiver
            unannouncedCapotCheckbox.parentElement.style.display = 'flex'; // Afficher la checkbox Capot non annoncé

            capotResultToggleGroup.style.display = 'none'; // Cache le toggle Capot réussi/chuté
            capotRealizedToggle.checked = true; // Par default, "Réussi"

            // Réactiver les champs et les rendre visibles par default
            contractPointsInput.disabled = false;
            contractPointsInput.style.backgroundColor = '#ffffff';
            contractInputAndButton.style.display = 'flex'; // Rétablir la visibilité du champ de contrat et bouton +10

            realizedPointsTeam1Input.disabled = false;
            realizedPointsTeam2Input.disabled = false;
            realizedPointsTeam1Input.style.backgroundColor = '#ffffff'; // Réinitialiser couleur
            realizedPointsTeam2Input.value = TOTAL_PLIS_POINTS - parseInt(realizedPointsTeam1Input.value); // S'assurer que ça somme à 162
            realizedPointsTeam2Input.style.backgroundColor = '#ffffff'; // Réinitialiser couleur
            realizedPointsTeam1Group.style.display = 'block'; // Rendre visible
            realizedPointsTeam2Group.style.display = 'block'; // Rendre visible


            announcementsTeam1Input.value = 0;
            announcementsTeam2Input.value = 0;
            takingTeamRadios.forEach(radio => radio.checked = false); 
            hideWarning(contractWarning);
            hideWarning(realizedPointsWarning);

            // Réinitialiser la sélection VISUELLE des couleurs ET l'objet currentContract pour l'affichage live
            suitIcons.forEach(icon => icon.classList.remove('selected'));
            
            currentContract = { 
                points: 0, 
                suit: '', 
                takingTeam: '', 
                type: '' 
            }; 
            updateContractDisplay(); // Cache l'affichage du contrat
            updateContractModifiersDisplay(); // Cache aussi l'affichage des modificateurs
        }

        // Fonction pour déclencher les feux d'artifice
        function triggerFireworks() {
            var duration = 10 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                var particleCount = 50 * (timeLeft / duration);
                // since particles fall down, start a bit higher than random
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }


        // Vérifie si la partie est terminée (et gère l'état du bouton "Ajouter points" et message de victoire)
        function checkGameEnd() {
            if (scores[TEAM1_ID] >= TARGET_SCORE || scores[TEAM2_ID] >= TARGET_SCORE) {
                addPointsButton.disabled = true; // Désactive l'ajout de points si la partie est finie
                let winner = '';
                let winnerColorClass = '';
                // Détecte si la partie vient juste de se terminer pour déclencher les feux d'artifice
                const gameJustEnded = (scores[TEAM1_ID] >= TARGET_SCORE || scores[TEAM2_ID] >= TARGET_SCORE) && addPointsButton.dataset.gameEnded !== 'true';

                if (scores[TEAM1_ID] >= TARGET_SCORE && scores[TEAM2_ID] < TARGET_SCORE) {
                    winner = teamNames[TEAM1_ID];
                    winnerColorClass = 'team1-color-text';
                }
                else if (scores[TEAM2_ID] >= TARGET_SCORE && scores[TEAM1_ID] < TARGET_SCORE) {
                    winner = teamNames[TEAM2_ID];
                    winnerColorClass = 'team2-color-text';
                }
                else {
                    if (scores[TEAM1_ID] > scores[TEAM2_ID]) {
                        winner = teamNames[TEAM1_ID];
                        winnerColorClass = 'team1-color-text';
                    }
                    else if (scores[TEAM2_ID] > scores[TEAM1_ID]) {
                        winner = teamNames[TEAM2_ID];
                        winnerColorClass = 'team2-color-text';
                    }
                    else {
                        winner = "Égalité ! Une manche supplémentaire peut être jouée.";
                        winnerColorClass = ''; // Pas de couleur spécifique pour l'égalité
                    }
                }
                winnerMessage.innerHTML = `<span class="${winnerColorClass}">${winner}</span> gagne la partie !`;
                winnerMessage.style.display = 'block';

                if (gameJustEnded) {
                    triggerFireworks(); // Déclenche les feux d'artifice
                    addPointsButton.dataset.gameEnded = 'true'; // Marque la partie comme "terminée" pour éviter de relancer les feux à chaque update
                }

            } else {
                addPointsButton.disabled = false; // Réactive l'ajout de points si la partie n'est pas finie
                winnerMessage.style.display = 'none';
                addPointsButton.dataset.gameEnded = 'false'; // Réinitialise l'état "gameEnded"
            }
        }

        // --- Fonctions de la modale de correction de score ---
        function openScoreCorrectionModal(teamId) {
            currentTeamBeingCorrected = teamId;
            modalScoreTitle.textContent = `Modifier le score de ${teamNames[teamId]} :`;
            modalScoreInput.value = scores[teamId];
            hideWarning(modalScoreWarning); // Cacher l'avertissement au début
            scoreCorrectionModal.style.display = 'flex'; // Afficher la modale (flex pour centrer)
            modalScoreInput.focus(); // Mettre le focus sur le champ de saisie
        }

        function closeScoreCorrectionModal() {
            scoreCorrectionModal.style.display = 'none'; // Cacher la modale
            hideWarning(modalScoreWarning); // Cacher l'avertissement
        }

        function saveCorrectedScore() {
            const newScore = parseInt(modalScoreInput.value);

            if (isNaN(newScore) || newScore < 0) {
                showWarning(modalScoreWarning, "Veuillez entrer un nombre positif valide.");
                return;
            }

            scores[currentTeamBeingCorrected] = newScore;
            updateDisplay();
            saveGame();
            checkGameEnd();
            closeScoreCorrectionModal();
        }

        // --- Fonctions de la modale de modification de nom ---
        function openNameCorrectionModal(teamId) {
            currentTeamNameBeingEdited = teamId;
            modalNameTitle.textContent = `Modifier le nom de ${teamNames[teamId]} :`;
            modalNameInput.value = teamNames[teamId];
            hideWarning(modalNameWarning); // Cacher l'avertissement au début
            nameCorrectionModal.style.display = 'flex'; // Afficher la modale (flex pour centrer)
            modalNameInput.focus(); // Mettre le focus sur le champ de saisie
        }

        function closeNameCorrectionModal() {
            nameCorrectionModal.style.display = 'none'; // Cacher la modale
            hideWarning(modalNameWarning); // Cacher l'avertissement
        }

        function saveCorrectedName() {
            const newName = modalNameInput.value.trim();

            if (!newName) {
                showWarning(modalNameWarning, "Le nom de l'équipe ne peut pas être vide.");
                return;
            }

            teamNames[currentTeamNameBeingEdited] = newName;
            updateDisplay();
            saveGame();
            closeNameCorrectionModal();
        }

        // --- Fonctions de la modale de confirmation "Nouvelle Partie" ---
        function openNewGameConfirmationModal() {
            newGameConfirmationModal.style.display = 'flex';
        }

        function closeNewGameConfirmationModal() {
            newGameConfirmationModal.style.display = 'none';
        }

        function startNewGame() {
            scores = {
                [TEAM1_ID]: 0,
                [TEAM2_ID]: 0
            };
            // Réinitialiser le contrat actuel
            currentContract = {
                points: 0,
                suit: '',
                takingTeam: '',
                type: ''
            };
            saveGame();
            updateDisplay();
            updateContractDisplay(); // Cache l'affichage du contrat
            resetInputFields();
            checkGameEnd(); // Réactive le bouton "Ajouter les points" et cache le message de gagnant
            closeNewGameConfirmationModal();
        }

        // --- Fonction de gestion du plein écran ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    fullscreenButton.textContent = "Quitter plein écran";
                }).catch(err => {
                    console.error(`Erreur pour passer en plein écran : ${err.message} (${err.name})`);
                    alert("Le mode plein écran n'est pas supporté par votre navigateur ou est bloqué.");
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen().then(() => {
                        fullscreenButton.textContent = "Plein écran";
                    });
                }
            }
        }

        // Écouteur pour le changement d'état du plein écran (par ex. si l'utilisateur appuie sur ESC)
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                fullscreenButton.textContent = "Plein écran";
            }
        });


        // --- Fonctions pour la modale de confirmation d'ajout de points ---
        function openAddPointsConfirmationModal(scoreForTeam1, scoreForTeam2, explanation, contractOutcome) {
            // Enlever le titre de la modale
            addPointsModalTitle.textContent = ''; 

            // Afficher le statut du contrat (réussi/chuté)
            contractResultStatus.textContent = `Contrat ${contractOutcome}`;
            contractResultStatus.classList.remove('contract-success-text', 'contract-failure-text'); // Nettoyer les classes
            if (contractOutcome === 'réussi') {
                contractResultStatus.classList.add('contract-success-text');
            } else if (contractOutcome === 'chuté') {
                contractResultStatus.classList.add('contract-failure-text');
            }

            confirmTeam1Name.textContent = teamNames[TEAM1_ID];
            // Ajouter les classes de couleur aux noms d'équipe
            confirmTeam1Name.classList.add('team1-color-text');
            confirmScoreTeam1.textContent = scoreForTeam1;
            
            confirmTeam2Name.textContent = teamNames[TEAM2_ID];
            // Ajouter les classes de couleur aux noms d'équipe
            confirmTeam2Name.classList.add('team2-color-text');
            confirmScoreTeam2.textContent = scoreForTeam2;
            
            // Afficher les détails du calcul
            calculationDetailsList.innerHTML = ''; // Nettoyer avant d'ajouter
            explanation.forEach(line => {
                const li = document.createElement('li');
                li.innerHTML = line;
                calculationDetailsList.appendChild(li);
            });

            hideWarning(addPointsConfirmationWarning);
            addPointsConfirmationModal.style.display = 'flex';
        }

        function closeAddPointsConfirmationModal() {
            addPointsConfirmationModal.style.display = 'none';
        }

        function confirmAddPoints() {
            // Appliquer les points stockés globalement
            scores[TEAM1_ID] += lastCalculatedScores[TEAM1_ID];
            scores[TEAM2_ID] += lastCalculatedScores[TEAM2_ID];

            updateDisplay();
            saveGame();
            resetInputFields(); // Réinitialise les champs et le contrat
            checkGameEnd(); // Vérifie l'état de la partie
            closeAddPointsConfirmationModal();
        }

        // --- Fonction principale de calcul des points d'une manche ---
        // Cette fonction retourne un objet avec les points pour chaque équipe et une explication détaillée.
        function calculateRoundPoints() {
            // Cacher tous les avertissements avant de lancer les validations
            hideWarning(contractWarning);
            hideWarning(realizedPointsWarning);

            let contractPoints = parseInt(contractPointsInput.value); 
            let takingTeamId = document.querySelector('input[name="takingTeam"]:checked')?.value; // Utilise optional chaining
            
            // Validation de l'équipe preneuse
            if (!takingTeamId) {
                showWarning(contractWarning, "Veuillez sélectionner l'équipe preneuse du contrat.");
                return { isValid: false };
            }
            
            let opposingTeamId = (takingTeamId === TEAM1_ID) ? TEAM2_ID : TEAM1_ID;

            let realizedPoints; // Sera utilisé si PAS un capot annoncé
            // Si les champs sont masqués, on doit forcer la valeur pour le calcul
            if (capotCheckbox.checked) {
                realizedPoints = 0; // Les plis ne sont pas pertinents pour le calcul du capot annoncé
            } else if (unannouncedCapotCheckbox.checked) {
                 // Si capot non annoncé est coché, on force 162 plis pour la preneuse pour le calcul
                 realizedPoints = TOTAL_PLIS_POINTS;
            } else {
                if (takingTeamId === TEAM1_ID) {
                    realizedPoints = parseInt(realizedPointsTeam1Input.value);
                } else {
                    realizedPoints = parseInt(realizedPointsTeam2Input.value);
                }
            }


            let isCoinched = coincheCheckbox.checked;
            let isSurcoinched = surcoincheCheckbox.checked;
            let isCapotAnnounced = capotCheckbox.checked; // Capot annoncé
            let isCapotRealizedAnnounced = capotRealizedToggle.checked; // Résultat du capot annoncé
            let isUnannouncedCapot = unannouncedCapotCheckbox.checked; // Capot réalisé non annoncé

            let announcementsTeam1 = parseInt(announcementsTeam1Input.value) || 0;
            let announcementsTeam2 = parseInt(announcementsTeam2Input.value) || 0;

            let preneurAnnouncements = (takingTeamId === TEAM1_ID) ? announcementsTeam1 : announcementsTeam2;
            let defenseurAnnouncements = (takingTeamId === TEAM1_ID) ? announcementsTeam2 : announcementsTeam1;
            const totalAnnouncements = announcementsTeam1 + announcementsTeam2;

            let pointsGainedByTakingTeam = 0;
            let pointsGainedByOpposingTeam = 0;
            let multiplier = 1;
            let explanation = [];
            let isValid = true;
            let contractOutcome = ''; // 'réussi' ou 'chuté'

            // --- Validation des entrées ---
            if (!isCapotAnnounced) {
                // MODIFICATION DE LA RÈGLE DE VALIDATION DU CONTRAT (plus de plafond)
                if (isNaN(contractPoints) || contractPoints < MIN_CONTRACT_POINTS || (contractPoints % 10 !== 0)) {
                     showWarning(contractWarning, `Le contrat doit être un multiple de 10 à partir de ${MIN_CONTRACT_POINTS}.`);
                     isValid = false; return { isValid: false };
                }
                if (!currentContract.suit) {
                    showWarning(contractWarning, "Veuillez sélectionner une couleur de contrat.");
                    isValid = false; return { isValid: false };
                }
            }

            if (!isCapotAnnounced && !isUnannouncedCapot && (isNaN(realizedPoints) || realizedPoints < 0 || realizedPoints > TOTAL_PLIS_POINTS)) {
                showWarning(realizedPointsWarning, `Les points réalisés (plis) doivent être entre 0 et ${TOTAL_PLIS_POINTS}.`);
                isValid = false; return { isValid: false };
            }
            
            if (isUnannouncedCapot && isCapotAnnounced) {
                showWarning(realizedPointsWarning, `Vous ne pouvez pas cocher "Capot annoncé" ET "Capot réalisé (non annoncé)" en même temps.`);
                isValid = false; return { isValid: false };
            }


            // --- Début du calcul et de l'explication ---
            explanation.push(`<strong>Équipe preneuse : ${teamNames[takingTeamId]}</strong>`);
            explanation.push(`<strong>Équipe défenseuse : ${teamNames[opposingTeamId]}</strong>`);
            explanation.push(`Annonces ${teamNames[takingTeamId]} : ${preneurAnnouncements} points`);
            explanation.push(`Annonces ${teamNames[opposingTeamId]} : ${defenseurAnnouncements} points`);


            if (isCoinched) {
                multiplier = 2;
                explanation.push(`Contrat Coinché (multiplicateur x${multiplier})`);
            }
            if (isSurcoinched) {
                multiplier = 4;
                explanation.push(`Contrat Surcoinché (multiplicateur x${multiplier})`);
            }
            
            if (isCapotAnnounced) { // Cas 1 : Capot annoncé
                explanation.push(`<strong>Capot annoncé !</strong>`);
                if (isCoinched || isSurcoinched) {
                    explanation.push(`Base de points pour Capot Coinché/Surcoinché : ${CAPOT_BASE_POINTS_COINCHE}`);
                    if (isCapotRealizedAnnounced) { 
                        // Capot annoncé ET Réussi ET Coinché/Surcoinché
                        pointsGainedByTakingTeam = (CAPOT_BASE_POINTS_COINCHE + totalAnnouncements) * multiplier + CAPOT_BASE_POINTS_COINCHE;
                        pointsGainedByOpposingTeam = 0;
                        explanation.push(`Capot annoncé <strong>réussi</strong>. L'équipe preneuse marque :`);
                        explanation.push(`(${CAPOT_BASE_POINTS_COINCHE} (base) + ${totalAnnouncements} (annonces totales)) x ${multiplier} (coinche/surcoinche) + ${CAPOT_BASE_POINTS_COINCHE} (prime capot)`);
                        contractOutcome = 'réussi';
                    } else { 
                        // Capot annoncé ET Chuté ET Coinché/Surcoinché
                        pointsGainedByTakingTeam = 0;
                        pointsGainedByOpposingTeam = (CAPOT_BASE_POINTS_COINCHE + totalAnnouncements) * multiplier + CAPOT_BASE_POINTS_COINCHE;
                        explanation.push(`Capot annoncé <strong>chuté</strong>. L'équipe défenseuse marque :`);
                        explanation.push(`(${CAPOT_BASE_POINTS_COINCHE} (base) + ${totalAnnouncements} (annonces totales)) x ${multiplier} + ${CAPOT_BASE_POINTS_COINCHE} (prime capot)`);
                        contractOutcome = 'chuté';
                    }
                } else { // Capot annoncé ET Normal (non coinché)
                    explanation.push(`Base de points pour Capot normal : ${CAPOT_BASE_POINTS_NORMAL}`);
                    if (isCapotRealizedAnnounced) { 
                        // Capot annoncé ET Réussi ET Normal
                        pointsGainedByTakingTeam = CAPOT_BASE_POINTS_NORMAL + preneurAnnouncements;
                        pointsGainedByOpposingTeam = defenseurAnnouncements;
                        explanation.push(`Capot annoncé <strong>réussi</strong>. ${teamNames[takingTeamId]} marque ${CAPOT_BASE_POINTS_NORMAL} (base) + ${preneurAnnouncements} (annonces).`);
                        explanation.push(`${teamNames[opposingTeamId]} marque ${defenseurAnnouncements} (annonces).`);
                        contractOutcome = 'réussi';
                    } else { 
                        // Capot annoncé ET Chuté ET Normal
                        pointsGainedByTakingTeam = 0;
                        pointsGainedByOpposingTeam = CAPOT_BASE_POINTS_NORMAL + defenseurAnnouncements + preneurAnnouncements;
                        explanation.push(`Capot annoncé <strong>chuté</strong>. ${teamNames[opposingTeamId]} marque ${CAPOT_BASE_POINTS_NORMAL} (base) + ${defenseurAnnouncements} (annonces défense) + ${preneurAnnouncements} (annonces preneur).`);
                        contractOutcome = 'chuté';
                    }
                }
            } else { // Cas 2 : Pas de Capot annoncé (contrat normal ou capot non annoncé)
                explanation.push(`Contrat : ${contractPoints} points`);
                explanation.push(`Plis réalisés par ${teamNames[takingTeamId]} : ${realizedPoints} points`);
                explanation.push(`Plis réalisés par ${teamNames[opposingTeamId]} : ${TOTAL_PLIS_POINTS - realizedPoints} points`);
                
                if (isUnannouncedCapot) {
                    explanation.push(`<strong>Capot réalisé (non annoncé) !</strong>`);
                    explanation.push(`Prime pour Capot non annoncé : ${CAPOT_UNANNOUNCED_POINTS} points`);
                    
                    // MODIFICATION ICI: Forcer le capot pour l'équipe preneuse
                    pointsGainedByTakingTeam = CAPOT_UNANNOUNCED_POINTS + contractPoints + preneurAnnouncements;
                    pointsGainedByOpposingTeam = defenseurAnnouncements;
                    explanation.push(`${teamNames[takingTeamId]} marque ${CAPOT_UNANNOUNCED_POINTS} (prime) + ${contractPoints} (contrat) + ${preneurAnnouncements} (annonces).`);
                    explanation.push(`${teamNames[opposingTeamId]} marque ${defenseurAnnouncements} (annonces).`);
                    contractOutcome = 'réussi'; // Pour un capot non annoncé, s'il est réalisé par le preneur, c'est un succès du point de vue des points.
                    
                } else { // Contrat normal (ni capot annoncé, ni capot non annoncé)
                     // Calcul de la réussite du contrat normal
                    let preneurTotalScoreForSuccess = realizedPoints + preneurAnnouncements;
                    let defenseurTotalScoreForSuccess = (TOTAL_PLIS_POINTS - realizedPoints) + defenseurAnnouncements;
                    const isContractSuccess = (preneurTotalScoreForSuccess >= (contractPoints + 2)) && (preneurTotalScoreForSuccess > defenseurTotalScoreForSuccess);

                    if (isCoinched || isSurcoinched) {
                        explanation.push(`Points des plis : ${realizedPoints} pour ${teamNames[takingTeamId]}, ${TOTAL_PLIS_POINTS - realizedPoints} pour ${teamNames[opposingTeamId]}.`);
                        explanation.push(`Total points (plis + annonces) : ${teamNames[takingTeamId]} = ${preneurTotalScoreForSuccess}, ${teamNames[opposingTeamId]} = ${defenseurTotalScoreForSuccess}.`);
                        
                        if (isContractSuccess) {
                            pointsGainedByTakingTeam = ((TOTAL_PLIS_POINTS - 2) + totalAnnouncements) * multiplier + contractPoints; 
                            pointsGainedByOpposingTeam = 0;
                            explanation.push(`Contrat <strong>réussi</strong>. ${teamNames[takingTeamId]} marque :`);
                            explanation.push(`(${TOTAL_PLIS_POINTS - 2} (base 160) + ${totalAnnouncements} (annonces totales)) x ${multiplier} + ${contractPoints} (contrat)`);
                            contractOutcome = 'réussi';
                        } else {
                            pointsGainedByTakingTeam = 0;
                            pointsGainedByOpposingTeam = ((TOTAL_PLIS_POINTS - 2) + totalAnnouncements) * multiplier + contractPoints;
                            explanation.push(`Contrat <strong>chuté</strong>. ${teamNames[opposingTeamId]} marque :`);
                            explanation.push(`(${TOTAL_PLIS_POINTS - 2} (base 160) + ${totalAnnouncements} (annonces totales)) x ${multiplier} + ${contractPoints} (contrat)`);
                            contractOutcome = 'chuté';
                        }
                    } else { // Contrat normal (ni coinché, ni surcoinché)
                        if (isContractSuccess) {
                            pointsGainedByTakingTeam = contractPoints + realizedPoints + preneurAnnouncements;
                            pointsGainedByOpposingTeam = (TOTAL_PLIS_POINTS - realizedPoints) + defenseurAnnouncements;
                            explanation.push(`Contrat <strong>réussi</strong>. ${teamNames[takingTeamId]} marque ${contractPoints} (contrat) + ${realizedPoints} (plis) + ${preneurAnnouncements} (annonces).`);
                            explanation.push(`${teamNames[opposingTeamId]} marque ${TOTAL_PLIS_POINTS - realizedPoints} (plis) + ${defenseurAnnouncements} (annonces).`);
                            contractOutcome = 'réussi';
                        } else {
                            // Chute du contrat normal: le défenseur marque le contrat + 162 + annonces de l'attaque + annonces de la défense
                            pointsGainedByTakingTeam = 0;
                            pointsGainedByOpposingTeam = contractPoints + TOTAL_PLIS_POINTS + defenseurAnnouncements + preneurAnnouncements;
                            explanation.push(`Contrat <strong>chuté</strong>. ${teamNames[opposingTeamId]} marque :`);
                            explanation.push(`${contractPoints} (contrat) + ${TOTAL_PLIS_POINTS} (points des plis) + ${defenseurAnnouncements} (annonces défense) + ${preneurAnnouncements} (annonces preneur).`);
                            contractOutcome = 'chuté';
                        }
                    }
                }
            }

            // Arrondir les points à la dizaine la plus proche
            pointsGainedByTakingTeam = roundToNearestTen(pointsGainedByTakingTeam);
            pointsGainedByOpposingTeam = roundToNearestTen(pointsGainedByOpposingTeam);

            let pointsForTeam1, pointsForTeam2;
            if (takingTeamId === TEAM1_ID) {
                pointsForTeam1 = pointsGainedByTakingTeam;
                pointsForTeam2 = pointsGainedByOpposingTeam;
            } else {
                pointsForTeam1 = pointsGainedByOpposingTeam;
                pointsForTeam2 = pointsGainedByTakingTeam;
            }

            explanation.push(`<br><strong>Points finaux arrondis :</strong>`);
            explanation.push(`Points ${teamNames[TEAM1_ID]} : ${pointsForTeam1}`);
            explanation.push(`Points ${teamNames[TEAM2_ID]} : ${pointsForTeam2}`);

            return {
                pointsForTeam1: pointsForTeam1,
                pointsForTeam2: pointsForTeam2,
                explanation: explanation,
                isValid: isValid,
                contractOutcome: contractOutcome // Ajout du résultat du contrat
            };
        }


        // --- Gestionnaires d'événements ---

        // Écouteur pour le bouton +10 du contrat
        addTenContractPointsButton.addEventListener('click', () => {
            let currentContractValue = contractPointsInput.value;
            let currentContractPoints;

            if (currentContractValue === '' || parseInt(currentContractValue) < MIN_CONTRACT_POINTS) { // Commencer à 70 pour arriver à 80
                currentContractPoints = MIN_CONTRACT_POINTS - 10; 
            } else {
                currentContractPoints = parseInt(currentContractValue);
            }

            // Pas de vérification MAX_CONTRACT_POINTS ici pour permettre de dépasser 160
            contractPointsInput.value = currentContractPoints + 10;
            // Déclencher l'événement input pour mettre à jour le contrat affiché
            contractPointsInput.dispatchEvent(new Event('input', { bubbles: true }));
        });


        // Gère l'état de "Surcoinche" en fonction de "Coinche"
        coincheCheckbox.addEventListener('change', () => {
            if (coincheCheckbox.checked) {
                surcoincheCheckbox.disabled = false;
            } else {
                surcoincheCheckbox.checked = false; // Désélectionne Surcoinche si Coinche est décochée
                surcoincheCheckbox.disabled = true;
            }
            updateContractModifiersDisplay(); // Mettre à jour l'affichage des modificateurs
        });

        // Gère l'état de "Coinche" en fonction de "Surcoinche"
        surcoincheCheckbox.addEventListener('change', () => {
            if (surcoincheCheckbox.checked) {
                coincheCheckbox.checked = true; // Coche "Coinche" si "Surcoinche" est cochée
                coincheCheckbox.disabled = true; // Désactive la possibilité de décocher "Coinche"
            } else {
                coincheCheckbox.disabled = false; // Réactive "Coinche" si "Surcoinche" est décochée
            }
            updateContractModifiersDisplay(); // Mettre à jour l'affichage des modificateurs
        });

        // Gère l'affichage du toggle Capot réussi / chuté et la désactivation d'autres champs si Capot annoncé est coché
        capotCheckbox.addEventListener('change', () => {
            if (capotCheckbox.checked) {
                capotResultToggleGroup.style.display = 'block'; // Afficher le toggle
                contractPointsInput.disabled = true; // Désactiver les points de contrat
                contractPointsInput.value = ''; // Vider le champ
                contractPointsInput.style.backgroundColor = '#e0e0e0'; // Griser le champ
                contractInputAndButton.style.display = 'none'; // Cacher le champ de contrat et bouton +...

                // Désactiver les champs de points réalisés si Capot annoncé est coché
                realizedPointsTeam1Input.disabled = true;
                realizedPointsTeam2Input.disabled = true;
                realizedPointsTeam1Input.value = TOTAL_PLIS_POINTS; // Mettre 162 par défaut pour l'équipe 1
                realizedPointsTeam2Input.value = 0; // Mettre 0 par défaut pour l'équipe 2
                realizedPointsTeam1Input.style.backgroundColor = '#e0e0e0';
                realizedPointsTeam2Input.style.backgroundColor = '#e0e0e0';
                realizedPointsTeam1Group.style.display = 'none'; // Cacher les groupes
                realizedPointsTeam2Group.style.display = 'none'; // Cacher les groupes

                // Désactiver la case "Capot réalisé (non annoncé)"
                unannouncedCapotCheckbox.checked = false;
                unannouncedCapotCheckbox.disabled = true;
                unannouncedCapotCheckbox.parentElement.style.display = 'none'; // Cacher la checkbox

                hideWarning(contractWarning); // Cacher l'avertissement de contrat
                hideWarning(realizedPointsWarning); // Cacher l'avertissement de points réalisés

            } else {
                capotResultToggleGroup.style.display = 'none'; // Cacher le toggle
                capotRealizedToggle.checked = true; // Réinitialiser à "Réussi"
                contractPointsInput.disabled = false; // Réactiver
                contractPointsInput.style.backgroundColor = '#ffffff'; // Réinitialiser couleur
                contractInputAndButton.style.display = 'flex'; // Rétablir la visibilité

                // Réactiver les champs de points réalisés
                realizedPointsTeam1Input.disabled = false;
                realizedPointsTeam2Input.disabled = false;
                realizedPointsTeam1Input.value = TOTAL_PLIS_POINTS / 2; // Remettre 81
                realizedPointsTeam2Input.value = TOTAL_PLIS_POINTS / 2; // Remettre 81
                realizedPointsTeam1Input.style.backgroundColor = '#ffffff';
                realizedPointsTeam2Input.style.backgroundColor = '#ffffff';
                realizedPointsTeam1Group.style.display = 'block'; // Rendre visible
                realizedPointsTeam2Group.style.display = 'block'; // Rendre visible

                // Réactiver la case "Capot réalisé (non annoncé)"
                unannouncedCapotCheckbox.disabled = false;
                unannouncedCapotCheckbox.parentElement.style.display = 'flex'; // Afficher la checkbox
            }
            updateContractDisplay(); // Met à jour l'affichage du contrat
            updateContractModifiersDisplay(); // Mettre à jour l'affichage des modificateurs
        });

        // NOUVELLE LOGIQUE POUR "Capot réalisé (non annoncé)"
        unannouncedCapotCheckbox.addEventListener('change', () => {
            if (unannouncedCapotCheckbox.checked) {


                // Forcer les points réalisés : 162 pour l'équipe preneuse, 0 pour la défense
                const takingTeamId = document.querySelector('input[name="takingTeam"]:checked')?.value;
                if (takingTeamId === TEAM1_ID) {
                    realizedPointsTeam1Input.value = TOTAL_PLIS_POINTS;
                    realizedPointsTeam2Input.value = 0;
                } else {
                    realizedPointsTeam1Input.value = 0;
                    realizedPointsTeam2Input.value = TOTAL_PLIS_POINTS;
                }
                realizedPointsTeam1Input.disabled = true;
                realizedPointsTeam2Input.disabled = true;
                realizedPointsTeam1Input.style.backgroundColor = '#e0e0e0';
                realizedPointsTeam2Input.style.backgroundColor = '#e0e0e0';

            } else {
                // Réactiver les champs et les masquer/afficher selon l'état de "Capot annoncé"
                contractPointsInput.disabled = false;
                contractPointsInput.style.backgroundColor = '#ffffff';
                contractInputAndButton.style.display = 'flex';

                capotCheckbox.disabled = false;
                capotCheckbox.parentElement.style.display = 'flex'; // Rendre visible
                // Réactiver la visibilité du toggle de capot annoncé si capotCheckbox est cochée
                if (capotCheckbox.checked) {
                    capotResultToggleGroup.style.display = 'block';
                }

                realizedPointsTeam1Input.disabled = false;
                realizedPointsTeam2Input.disabled = false;
                realizedPointsTeam1Input.value = TOTAL_PLIS_POINTS / 2; // Remettre 81
                realizedPointsTeam2Input.value = TOTAL_PLIS_POINTS / 2; // Remettre 81
                realizedPointsTeam1Input.style.backgroundColor = '#ffffff';
                realizedPointsTeam2Input.style.backgroundColor = '#ffffff';
            }
            updateContractDisplay(); // Met à jour l'affichage du contrat
            updateContractModifiersDisplay(); // Mettre à jour l'affichage des modificateurs
        });


        // Gère la mise à jour des points réalisés de l'équipe adverse
        realizedPointsTeam1Input.addEventListener('input', () => {
            let val = parseInt(realizedPointsTeam1Input.value);
            if (!isNaN(val)) {
                realizedPointsTeam2Input.value = TOTAL_PLIS_POINTS - val;
            }
        });

        realizedPointsTeam2Input.addEventListener('input', () => {
            let val = parseInt(realizedPointsTeam2Input.value);
            if (!isNaN(val)) {
                realizedPointsTeam1Input.value = TOTAL_PLIS_POINTS - val;
            }
        });

        // Mise à jour de l'objet currentContract pour l'affichage dans le header
        contractPointsInput.addEventListener('input', () => {
            currentContract.points = parseInt(contractPointsInput.value) || 0;
            updateContractDisplay();
        });

        takingTeamRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                currentContract.takingTeam = radio.value;
                updateContractDisplay();
            });
        });

        suitIcons.forEach(icon => {
            icon.addEventListener('click', () => {
                // Désélectionner toutes les icônes d'abord
                suitIcons.forEach(i => i.classList.remove('selected'));
                // Sélectionner l'icône cliquée
                icon.classList.add('selected');
                currentContract.suit = icon.dataset.suit;
                updateContractDisplay();
            });
        });

        // Empêche le capot non annoncé si un capot est annoncé et vice versa
        capotCheckbox.addEventListener('change', () => {
            if (capotCheckbox.checked) {
                unannouncedCapotCheckbox.disabled = true;
                unannouncedCapotCheckbox.checked = false; // décocher si l'autre est cochée
            } else {
                unannouncedCapotCheckbox.disabled = false;
            }
            updateContractModifiersDisplay(); // Mettre à jour l'affichage des modificateurs
        });

        unannouncedCapotCheckbox.addEventListener('change', () => {
            if (unannouncedCapotCheckbox.checked) {
                capotCheckbox.disabled = true;
                capotCheckbox.checked = false; // décocher si l'autre est cochée
                capotResultToggleGroup.style.display = 'none'; // Assurer que le toggle est masqué
            } else {
                capotCheckbox.disabled = false;
            }
            updateContractModifiersDisplay(); // Mettre à jour l'affichage des modificateurs
        });


        // Gestionnaire pour le bouton "Ajouter les points"
        addPointsButton.addEventListener('click', () => {
            const result = calculateRoundPoints();

            if (result.isValid) {
                // Stocker les points calculés pour la confirmation
                lastCalculatedScores[TEAM1_ID] = result.pointsForTeam1;
                lastCalculatedScores[TEAM2_ID] = result.pointsForTeam2;
                lastCalculationExplanation = result.explanation;
                lastContractOutcome = result.contractOutcome;

                // Afficher la modale de confirmation
                openAddPointsConfirmationModal(
                    result.pointsForTeam1,
                    result.pointsForTeam2,
                    result.explanation,
                    result.contractOutcome
                );
            }
        });

        // Gestionnaires d'événements pour les modales de correction de score et nom
        document.querySelectorAll('.team-score').forEach(element => {
            element.addEventListener('click', function(event) {
                // Empêche l'ouverture si le clic vient du texte du score lui-même, qui gère le clignotement
                if (event.target.classList.contains('score-value')) {
                    openScoreCorrectionModal(this.dataset.teamId);
                } else if (event.target.tagName === 'H2') { // Si le clic est sur le nom de l'équipe (H2)
                    openNameCorrectionModal(this.dataset.teamId);
                }
            });
        });

        // Gestionnaires pour les boutons des modales de correction
        saveScoreButton.addEventListener('click', saveCorrectedScore);
        cancelScoreButton.addEventListener('click', closeScoreCorrectionModal);
        scoreModalCloseButton.addEventListener('click', closeScoreCorrectionModal);

        saveNameButton.addEventListener('click', saveCorrectedName);
        cancelNameButton.addEventListener('click', closeNameCorrectionModal);
        nameModalCloseButton.addEventListener('click', closeNameCorrectionModal);

        // Gestionnaires pour la modale "Nouvelle Partie"
        newGameButton.addEventListener('click', openNewGameConfirmationModal);
        confirmNewGameButton.addEventListener('click', startNewGame);
        cancelNewGameButton.addEventListener('click', closeNewGameConfirmationModal);
        newGameModalCloseButton.addEventListener('click', closeNewGameConfirmationModal);

        // Gestionnaires pour la modale de confirmation d'ajout de points
        confirmAddPointsButton.addEventListener('click', confirmAddPoints);
        cancelAddPointsButton.addEventListener('click', closeAddPointsConfirmationModal);
        addPointsModalCloseButton.addEventListener('click', closeAddPointsConfirmationModal);

        // Gestionnaire pour le bouton plein écran
        fullscreenButton.addEventListener('click', toggleFullScreen);


        // --- Fonctions pour sélectionner le texte au focus (amélioration UX) ---
        function selectTextOnFocus(inputElement) {
            if (inputElement) {
                inputElement.addEventListener('focus', function() {
                    // Utilise setTimeout pour s'assurer que le select() est appelé après que le focus soit bien établi.
                    // Cela aide sur certains navigateurs et dans des cas où le champ est désactivé puis réactivé.
                    setTimeout(() => {
                        this.select();
                    }, 0);
                });
                // Pour les navigateurs mobiles, keyup peut être plus fiable que focus
                inputElement.addEventListener('mouseup', function(e) {
                    e.preventDefault(); // Empêche le désélectionnement si le click fait un drag involontaire
                    this.select();
                });
            }
        }

        // --- Initialisation au chargement ---\
        document.addEventListener('DOMContentLoaded', () => {
            loadGame();
            resetInputFields(); // Assure que les champs sont propres au démarrage et que le contrat affiché est masqué
            // Le bouton "Ajouter les points" est réactivé via checkGameEnd() appelé par loadGame()

            // --- Ajout pour forcer la fermeture des modales au démarrage ---\
            closeNewGameConfirmationModal();
            closeNameCorrectionModal();
            closeScoreCorrectionModal();
            closeAddPointsConfirmationModal(); // Nouvelle modale à fermer au démarrage

            // --- Appliquer la sélection au focus pour les champs de saisie ---\
            selectTextOnFocus(contractPointsInput);
            selectTextOnFocus(announcementsTeam1Input);
            selectTextOnFocus(announcementsTeam2Input);
            selectTextOnFocus(realizedPointsTeam1Input);
            selectTextOnFocus(realizedPointsTeam2Input);
            selectTextOnFocus(modalScoreInput);
            selectTextOnFocus(modalNameInput);
        });
    </script>
</body>
</html>
